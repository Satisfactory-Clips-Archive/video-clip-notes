---
title: "May 28th, 2021 Livestream Q&A: Can you give a quick explanation of how the system for Lights works right now?"
date: "2021-05-28"
layout: transcript
topics:
    - "environment/creatures/lizard-doggo"
    - "features/buildables/conveyor-belts"
    - "features/buildables/lights"
    - "features/possible-features/decor"
    - "satisfactory-updates/seasonal-events"
    - "technology/graphics"
    - "technology/unreal-engine"
    - "technology/unreal-engine/distance-fields"
---
# [May 28th, 2021 Livestream](../2021-05-28.md)
## Q&A: Can you give a quick explanation of how the system for Lights works right now?
https://youtube.com/embed/dyqOMITwLsY?autoplay=1&start=199&end=449

### Topics
* [Environment > Creatures > Lizard Doggo](../topics/environment/creatures/lizard-doggo.md)
* [Features > Buildables > Conveyor Belts](../topics/features/buildables/conveyor-belts.md)
* [Features > Buildables > Lights](../topics/features/buildables/lights.md)
* [Features > Possible Features > Decor](../topics/features/possible-features/decor.md)
* [Satisfactory Updates > Seasonal Events](../topics/satisfactory-updates/seasonal-events.md)
* [Technology > Graphics](../topics/technology/graphics.md)
* [Technology > Unreal Engine](../topics/technology/unreal-engine.md)
* [Technology > Unreal Engine > Distance Fields](../topics/technology/unreal-engine/distance-fields.md)

### Transcript

> so if you're ready then i'm ready always ready cool all right spaghetti hi hi everybody my name is snoot and i'm one of the community managers here at coffee scene studios and today we're going to share some insight of some of the systems that we've implemented for update 4 in order to bring you lights uh we're also going to be talking a little bit about the dismantle effect and why we changed that and a little bit what's coming in the future for that and we're just going to talk some general like performance techniques that we're using to improve performance in the game and in order to do so i'm joined by our technical artist ben who is going to be sharing some of his insights so hi ben hello uh ben's been featured before in our videos there's like a link in one of the cards here probably with a video with jace uh where we showcased some of the water and like some of the screen space reflective surfaces stuff like that so if you're interested in that check out that video um but for people who may not know could you maybe describe a little bit like what's your role as a technical artist is and what you do as a technical artist you are involved with the art and the technical part of the game so you're making sure that the art will function perform and works with the gameplay elements so that's it in a nutshell at coffee stain we're a small studio so there's only one tech artist which means i'm also involved with performance some programming tasks too and just in general making sure that the whole project runs tm nice cool all right so let's dive into it let's talk about lights because that's the main thing that's new in update four and i think one of the hypest things in update four so what was like the main issue with implementing lights and like why couldn't we just slap lights into the game with like the objects that we had sort of so first case is the the infamous object limit that's one of the reasons because if you want to build an object you need to have the object in the world and we couldn't allow that because that would just add thousands of thousands of objects that would do nothing most of the time so we had to find a nice solution for that and second of it lights are really expensive when they're overlapped with each other that's something that we had to find some kind of solution for too and also to make it nice for multiplayer like just imagine somebody has to spend a spawn point with 5000 lights on the hub the player that joins it that can't leave it because their computer will just blow up right so for all those things we had to implement the system to manage lights and in the end it was a system to manage objects in general also to clarify when we talk about the object limit we're talking about like memory not like um the well it's kind of tied to that but it's not like necessarily one-to-one with like the amount of objects you place in the world it's it's more tied to like what the memory footprint of each game object has in the world rather just add on that it is the objects that are an unreal garbage collection reflection system right because an object doesn't need to be managed by unreal but best cases it is managed by unreal right cool cool so can you just give like a quick uh explanation of like how light this like the system for lights works right now i haven't anything set up to show so i'm first gonna show problems with light i'm totally not using our first of april settings so here we have a beautiful statue and these are like 50 lights overlapping so if we show our performance it's uh it's kind of that we're running at less than 30 fps even though not much is going on here that looks great so the yeah i know i love the floating floating peeps uh so the first thing we did an engine upgrade to 25 i think which gave us a nice future which is the rendering threat the rhi threat
>
> [Music]
>
> which gives us tons of performance back already the rhi stands for rendering hardware interface which is epic solution for different rendering apis and with the engine upgrade we are allowed to use in separate fret for this so partially the work is offloaded to a separate threat instead of only on one fret so this is acceptable now so now we can go to stage two of the explanation so the second thing we did with light is normally you would use inverse square falloff which makes the light look pretty realistic but the problem is they lose a lot of intensity so instead of that we are using no falloff so the light is the same strength as the beginning as the end which allows us to have the right distance for the light so they are way less performance impactful and they need to overlap way less to get intensity that you would desire right so they're not like realistic in the sense that most other lighting in the game is but they kind of need to to make sense for the users yes and here we see the example how it works with a ceiling light so we slap a cookie cutter on it uh called a light function and then we cut out the square so it's technically this light but we just cut out the other parts right and then the biggest issue with the light is shadows so let's go to the shadow part so we have three options uh no shadow casting which looks disappointing there's absolutely no shadows from anything the second option is cascaded shadow mapping um this is the classic way of doing it we have been doing that ever since i don't know 2005 probably it's it's expensive because just imagine the light being a camera it looks what is visible and then makes a depth map and projected shadows on the world that way so the more objects the light is hitting the more expensive the shadows will get which is absolutely not ideal in an infinite builder game so and then we have the last option which is distance field based lights uh shadows uh it has some downsides our conveyor belts are not shadowed unlike in this case there there is shadows from the conveyor belt that's why we use the mix solution for the directional light and as you can see some shadow artifacts will pop up and that's because distance fields are technically a 3d rep 3d texture of the mesh itself so if i quickly eject this is the distance fields for those objects they look a bit of funky but it's easier for the gpu to calculate it because it's just direct information there it doesn't really need to do much curling because it's it's gpu to gpu data but it's like 25 to 50 faster especially with the rendering uh the error hia threat uh that made it even more fast uh so yeah that's why we're using that right and like so so you mentioned that like conveyor belts aren't using distance field uh is there anything else apart from from the conveyors yes uh oh yes i'm not running today so the limitation is also skeletal meshes uh as you can see just the top part totally disappeared right and for people that may not know skeletal meshes are when you have like bone structures to to to meshes or the models in the game so like if you want to animate a character you need to tie in how like you have like a bone structure underneath anything and then when you render it you render it based on like where that bone is so when you're like running the bone will animate where the mesh like the part of the mesh is essentially and some of our buildings are animated and some parts of our building are static so one question that i've been getting uh is regarding if we are going to implement so you can turn like lights upside down and stuff like that um because i believe there's a reason why that isn't working right now or something like that the reason is because i forgot to implement something that's the fairy that's the fair reason um so basically how our lights work they trace down so they get the right length um because the way how i want how i envisioned lights to work is they would be content context aware so they wouldn't just try to go all the way through the world because that would cause a lot of draw calls right because of the shadows so the lights do a line trace with a maximum distance um they should take the maximum distance if they fail to find anything um there are some cases where they don't and that's something i still have to patch up right so that's something that same might come in the future then yeah okay and same with the glass um currently they block less because it's a foundation piece but it should of course ignore glass but that's totally a future for now is that tricky because the you you'd need to like separate out the glass portion of the foundation portion and what not on those pieces or oh i i would just oh if it's a glass just trace through it right okay who cares let's trace through it nobody will know awesome is there anything else that you're planning to do with lights in the future no i think this is kind of it um it would be cool to be able to have like um like motion sensory that would be really dope to have that's stuff we talked about but we didn't make or couldn't make i think it would be really cool that if you'd enter your factory and the lights turn on for example like a sensor gate like stuff like that would be really cool or that you can give them inputs but we'll see maybe we get there in the future sounds cool if you guys think that sounds cool make sure to go to our qa site questions on satisfactorygame.com and upload that because i'm pretty sure there's a ticket for that um and make sure to let us know how much you want that cool and then we hear you finally have the ceiling lights so we have been cheating we've been lying i'm really sorry for that but those fog planes are not real there's no real mist going on uh they they just they just looked like this with a beautiful shader on top of it yeah that's it to be fair most lighting in games that have those type of like they're they're usually a mesh that you just do that with so it's not an actual it's really expensive to do for your mattress we looked at it and just like maybe neural five um i wish so for the lights we use a an implementation that's quite common in games called pooling so basically what it does it has a lot of information points of like okay here could be a light there could be a light there could be light and we have an additional background threat for that uh hence uh people might have seen some crashes there but the background threat basically looks where the player is and then gets all those points okay these are relevant so we have a beautiful debug view for that where we can see all those points so these lights have one on the top and one on the bottom and here you can maybe see this one is of class of a light so there's a spotlight being pulled right here from this buildable and that way if i change the amount of lights are allowed it counts we might put these in the description too because people can use these commands in the game too so if you put one light then it will try to find the most relevant light for the player gotcha and this explains where some people have noticed that like if they have a ton of lights and they're running around the factory sometimes they can see like turn off in the distance and that's because of the cooling system that's like telling the game that like there's too many lights going on right now okay not everyone can be on at the same time okay cool that's kind of the problem with it um in theory you can have as i mean as many light as you want until your engine crashes because we didn't clap clamped yet so have fun with that yeah i was making the the trailer i tried to like what's the maximum of lights i could try and then it just absolutely wrecked my computer i got like a thousand error messages that was fun so yes uh we are also using this for the fog planes um the fog planes are like the let's make it uh daylight the fog planes are like the the shadow planes that are in front of the inputs and outputs so we can make it look like the items are going properly into the actor instead of just clipping into them but the problem was like the constructor was an example of really object expensive because it had four fog planes even though it was just one yeah yeah it was like four four objects per constructor you need to build a lot of construct just to be able to play the game i guess so we if you have tango structures you have 40 objects that are just those planes that is so ridiculous so that's why these are also in the pool system and it saves a lot of objects for a lot of people so people should be able to build way way more since update 4. cool i believe you also mentioned this in the last video actually you made with chase where this is something that we're going to do in the future here we are in the future the future is the solution cool um and now i can instantly also show off an op another optimization we did um maybe people didn't notice yet but they don't have likes anymore yeah so what we do with the legs now is we only give them legs when it's relevant so if they're on the slope we give them legs some buildings still have legs like the the space elevator obviously because it's they are unique to them they look really good on them too without it it looks a bit weird uh the hubs still have them and uh what's called again the nuclear reactor i think you still have them so we we have cases where they're still enabled but in general they are disabled and also the constructor has four legs but it means it has the leg and the feet so that would be eight components for just one constructor right again so those are very super easy wins and they also help a lot with loading and saving hence we are going now to the holograms so the main reason why we changed holograms that was because it was just causing a lot of memory issues um it became more apparent with update ford for some reason some things changed in the renderer that made it even worse also the conveyor belt items were an offender in that but if we get later to that so instead of swapping the instance mesh as they are now now they are instance of the conveyor all the constructors are one instance now what we used to do we used to uninstance the mesh and then make it a hologram which means every object of us instance is modified too for constructors that might not be the worst but for walls or foundations imagine you have twenty thousand foundations it means all those twenty thousand foundations are modified because you wanna hover on one foundation um so some people on really big saves just had lag spikes modifying their infrastructure right which is not fun so that was one of the main reasons the loading part is for every object that had to be instanced it had to create its render state so telling the render threat and the gpu that they should exist ironically the frame after it they were removed from the gpu so it adds tons and tons of data and i've removed it the frame after it so the loading time got increased with like 30 to 40 percent so it just did a ton of like unnecessary work at the first frame of the game and then just threw that kind of away yeah and that was also a reason for the dx12 in instability um right so that should be improved with that too i hope maybe tm futures could you just like uh quickly uh describe like what instancing means and like when we talk about that so that people are aware of what the implication of an instance in a game is when you're rendering stuff so an instance is you have several way of rendering items so you can just say like okay this isn't rock just render this one single rock here which is fine you render the rock uh with instancing basically you tell like okay there are 20 rocks here and it can do the task 20 times in sequence which is really fast because it doesn't need to read the data again gpus are really fast they're really bad at switching tasks right so it's really fast to render 20 times the same object in sequence knowing it's the same thing then to render 20 times the same object without knowing it's the same thing in the sequence right so it essentially batches up the things you want to render to when you're telling the gpu to render them essentially yeah and then unreal has their own implementation on top of that which is an hierarchically uh based rendering which does the best of both worlds so it has all the instances and it prepares clusters for themselves uh which also allow loading and curling and all the optimizations normal instances cannot do so that's like the best ideal case for instancing um we use it on absolutely everything yeah all the walls are done that way everything except for this little bastard
>
> [Laughter]
>
> so yes cool so the holograms now use stencils instead of the mesh itself so if we would show a stencil
>
> [Music]
>
> and what is a stencil this is a stencil so we are allowed to write an id a bit to a separate buffer and we can read that buffer in post-processing and based on that buffer we can um apply certain effects so if i would change to two three four five here we go we have different ids and if we go back into the game view there we go and then we can apply an outline to it with that effect magic dismantle effect so now you can dismantle this rock totally not a lie but this is how we can apply the hologram to this rock for example so essentially what you're doing when you're doing the hologram effect now instead is you're kind of drawing on top of the screen sort of with effect rather than it being like how everything else is rendered in the game where it's all like word space and it's yeah yeah so technically it's like putting on shades for this specific object right and i guess the limitation of doing it that way means that you can't have transparency on that object anymore because you're setting the the the frame is already drawn and you're drawing on top of the frame so it's impossible for you to know like what's behind something that's already been rendered that's the problem with it but the trade-off was so great because accidentally it also improved saving times which was not the intention but still could win i understand why after the fact but i didn't think about it when we were doing it let's say that way um and also one we'll take it you know what we'll take it okay we'll take any benefit that we can get from anything fair enough uh and also one thing that we want to add in the future we didn't have the ui for it yet but we want to add your own colored holograms so if you don't like the red for invalid placement you can just make it pink or you can make it orange whatever you want and this is also an accessibility feature for people that are colorblind for example that see certain colors differently than we see so they can make it fit for themselves sweet so there you go fam a little little bit of a secret thing that's coming in update 5 potentially hopefully fingers crossed most likely being able to do some some ux tweaks to it cool all right should we move on to the next thing we're going to the big bus the big bus this one doesn't mess around the big bus so this is my beautiful test case for oh and realistic conveyor belt case i recognize let's talk about conveyor belts um with the engine upgrade we faced the same issue that we got with the loading the conveyor belts got way more expensive to render i kind of figured out why but we cannot change it because it's like in the core of the rendering system of unreal which is such a black box to me that it's like can't touch this so we decided to find our way around it um let's disable the average heifer to begin with and go to the old system of whereabouts so this is the old conveyor belt system that's still accessible to everybody you can see the beautiful colors just to turn like are yellow even on my shitty screen share what i don't even get like a proper frame rate i i'm like noticing the difference here yep um also a lot of items look like they're moving backwards uh thanks to the framerate but we figured out that updating instances became more expensive sadly enough i assume it has to do with gpu bandwidth and threading and all that stuff that got improved so they had to cut corners elsewhere i assume i still didn't fully figure out but we'll see so our solution to that is what if we don't update the instances so that was the solution in the end so what we do instead we render the positions of the items on a texture and in the material we read where those items are so if i can find that subsystem here we can see how it looks like if it doesn't crash please okay so here we see all the items in the scene right now on the texture what a weird way to present that or look at it so technically it's it's just an array to the array of items um it's a floating texture which is not representable in colors so that's why it looks super weird every row is an item at least every three rows is an item because the first id is the lot zero then lot one lot and then the last slot and then we store xyz of this of course and the alpha is just there interesting and we do the same for the orientation which is looking even more weird yeah because this is this is readable but it's not because we're using quaternions yeah um i don't want to go into quaternions because nobody wants to because they're weird yeah uh they're super weird it's like let's represent an orientation with four numbers yep yeah uh and also they are going from negative one to positive one to make it even more obvious what it is so yeah we're using quaternions for that the reason for that it's easier to do it in the shader you can just multiply by quaternion and they get the right offset instead of doing xyz rotation then you have to do the right order and yeah right do you get like precision issues being that you render it to a buffer or does it actually like not really matter surprisingly i haven't noticed anything yet because it's in 32-bit buffer per channel yeah so it's quite memory expensive but it's again it's cheaper than having and and okay just just do a few step back we used to have a instance component per unique item per conveyor belt right let it sink in so if you would have five different items on the long conveyor belt you have five unique components in the end that was more of a memory sink than having a big ass texture or 32 uh 32 bits per channel uh that was just cheaper like in the end this is taking 1100 kilobytes to render uh so that that's pretty cheap how does it scale when you have like 10 times as many conveyor belts as you have in this scene versus like you know a million millions of creative ones or whatever it has a cutoff point at one point it just doesn't render the last lot right i'm not sure if we can get there that's pretty far away yeah here you can see that the purple line and the purple fade away it's really difficult to see but it's quite far you can almost not see the items anymore uh and there is consideration to make like a far distant version for far distance only but if we get there yeah and um the biggest cost of this system is on the cpu right now which is costing this scene is costing 1.1 milliseconds to do to render all these items and update it because it needs to run on the game thread sadly enough okay it was fully threaded it was fully working and then i pushed it out and everybody in the studio was crashing i was like but it works on my machine so one of those classic ones like with threading that works in your machine and then other people yeah except for only me and dylan were were running it and everybody else was crashing so i was like yay well obviously you and dylan were doing something much better than everyone else of course obviously um so yeah i had to strip it out and have to add that back one day cool so yeah those those are the items they are nice so i guess there's still like a couple of uh i've seen some people say that there's still a couple of parts that haven't moved over to like the new system um if you do find these make sure to go to our qa site questions outside of factorygame.com and let us know and that goes for all rendering issues you might face in the game i remember there being a period where you hadn't implemented being able to pick up items on the belts is there anything interesting to share about that because it's you're not actually like since these aren't actually like physical objects in the world uh like how does that work when you're wanting to pick up this particular instance um we have handle states for that state handles i guess they're called um basically the old implementation was relying on the instance component that was under relying in a way just to check if it existed or not but that's it it didn't even use it so the only fix for that was just saying like okay you can always do it okay but otherwise how it works it all the belts are on splines let's see you see the white thin line oh i wish i had more vertices more words please so basically that line represents the belt so this is zero and that is one and we can calculate from where the player is looking which item to highlight right this is getting too much slower
>
> [Music]
>
> so we just make an approximation from looking at the belt because if you hover on the item you're not getting the item either so it's it's really based on the belt itself yeah um instead and i guess we cannot make thousands of hitboxes for that all the time yeah just not doable and i guess that's the limitation of doing it this way it's just that it's not like i said it's not an actual object in the world it's part of the belt so to speak yeah it's abstract data being represented yeah cool so what's what's coming in the future when it comes to optimization for satisfactory what what's planned on your your backlog if there's anything you can talk about that we haven't revealed yet yeah one of the things i really want to do still is split the world in smaller parts because a lot of people are like oh my god when i cross this line my game lags it's like yep that's because you're loading in 100 megabytes of data and that needs to go to the gpu and and the foliage needs to rebuild so basically what i want to do is to split up the worlds in smaller sections and this way the stutter should be less or even not apparent so that would be the ideal case but we kind of have the workflow issue that the world is in a different branch otherwise we have problems with releasing updates because that means that hana and mihil need to work their ass off so we can release factory content so that's why that stuff is being slow on our side i guess right workflow reasons and branching and all the shenanigans cool the other thing i really want to make hardly instant splines but yeah that's that's something uh we've been talking about since since we made splines i think uh well just to break the ice i got it working but i don't yeah so they work but they're not worth it at the moment so yeah because there was a time when not even like the splines themselves for instance and then instanced and uh yeah the performance wasn't great at that point yep it's much better oh holy i guess that sums it up all right thanks ben for for all the insight and uh thank you so much for watching make sure to like subscribe and all that jazz if you thought this was insightful and hopefully we'll see each other soon enough so take care everybody bye bye oh i was like did i not record okay i did um
